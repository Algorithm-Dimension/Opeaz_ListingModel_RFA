<script>

  $(document).ready(function() {
  console.log('coucou');
  // Disable group and pharmacy choice before choosing the type
    disableButton('id_pharmacy');

      $('#id_type').on('change', function() {
      var chosenType = document.getElementById(`id_type`).value;
      if (chosenType === 'group') {
            enableButton('id_group');
            disableButton('id_pharmacy');
            }
      else {
          disableButton('id_group');
          enableButton('id_pharmacy');
    }
  });

     var btnValue = "";

    var formCount = 1;

<!--### Ajouter la valeur de Et ou Ou dans un form pour le recuperer en back-->

    function addBtnValueInput(newForm){
      var newInput = document.createElement('input');
      newInput.setAttribute('name', 'btn_type_' + formCount);
      newInput.setAttribute('id', 'btn_type_' + formCount);
      newInput.style.display = 'none';
      newInput.value = btnValue;
      newForm.appendChild(newInput);

}

    function addForm(formHTML, width) {
      var htmlString =

      `<div class="form" id="form-${formCount}">
      <h4> ${btnValue} CONDITION ${formCount}</h4>
      <div style="width: ${width}px; line-height: 3;">
      {% csrf_token %}
      ${formHTML}
      </div> </div>
      <br><br>`;

      $('#form-container').append(htmlString);
      var formContainer = document.getElementById('form-container');
       addBtnValueInput(formContainer);

      // Change name and id of each field
      $('#form-' + formCount + ' :input').each(function() {
      var fieldName = $(this).attr('name');
      $(this).attr('name', fieldName + '_' + formCount);
      var fieldId = $(this).attr('id');
      $(this).attr('id', fieldId + '_' + formCount);
    });

      formCount++;
    }

   function disableButton(id){
   var btn = $('#' + id);
   btn.attr('disabled', 'disabled');
   }

   function enableButton(id){
   var btn = $('#' + id);
   btn.removeAttr('disabled');
   }

  function enableAddButtons() {
    enableButton('add-simple');
    enableButton('add-comparative');
    enableButton('add-no-condition');
  }

  function disableAddButtons() {
     disableButton('add-simple');
     disableButton('add-comparative');
     disableButton('add-no-condition');
  }



function clickOnAddForm(simpleFormHTML, width) {
  addForm(simpleFormHTML, width);
  $('.form-btn').each(function() {
    $(this).show();
  });
  disableAddButtons();

  var whatElement = document.getElementById(`id_simple_what_${formCount - 1}`);
  var unitElement = document.getElementById(`id_simple_unit_${formCount - 1}`);

  $(`#id_simple_what_${formCount - 1}`).on('change', function() {
    disableChoices(whatElement, unitElement);
  });
}



  function disableChoices(whatElement, unitElement) {
    var selectedValue = whatElement.value;

      // Enable all options in unit
      for (let i = 0; i < unitElement.options.length; i++) {
        unitElement.options[i].disabled = false;
      }

      // Disable specific options based on selectedValue
      if (selectedValue === 'gondole') {
        unitElement.options[1].disabled = true;
        unitElement.options[2].disabled = true;
        unitElement.options[3].selected = true;
      }



  }
  $('#add-simple').click(function() {
    var simpleFormHTML = `{{ simple_condition_form.as_table }}`;
    clickOnAddForm(simpleFormHTML, 1250);
    changeSubtype('simple', (parseInt(formCount) - 1));
  });

  $('#add-comparative').click(function() {
    var comparativeFormHTML = `{{ comparative_condition_form.as_table }}`;
    clickOnAddForm(comparativeFormHTML, 1300);
    changeSubtype('comp', (parseInt(formCount) - 1));

  });

  $('#add-no-condition').click(function() {
    var comparativeFormHTML = `{{ no_condition_form.as_table }}`;
    clickOnAddForm(comparativeFormHTML, 1300);
  });

  $('#and-btn').click(function() {
    enableAddButtons();
    btnValue = "ET";
  });
  $('#or-btn').click(function() {
    enableAddButtons();
    btnValue = "OU";

  });
      function changeSubtype(prefix, index) {
      $('#id_' + prefix + '_who_' + index).on('change', function(){
      var selectedValue = $(this).val();

    var formIndex = parseInt($(this).attr('id').split('_').pop());  // Get the index of the current form

    var subtypeField = $('#' + 'id_' + prefix + '_subtype_' + index);
    $.ajax({
      url: '/api/subtypes/' + selectedValue,
      type: 'GET',
      dataType: 'json',
      success: function(data) {
        var uniqueChoices = Array.from(new Set(data));
                console.log('Unique Choices:', uniqueChoices);
          subtypeField.empty();

        $.each(uniqueChoices, function(index, choice) {
          addOption(subtypeField, choice);
        });
      }
    });
  });

  function addOption(field, choice) {
    field.append($('<option></option>').attr('value', choice).text(choice));
  }
}

    });
  </script>
